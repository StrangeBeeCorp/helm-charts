###############################
# Cortex Helm Chart variables #
###############################

# Refer to [this documentation page](https://docs.strangebee.com/cortex/installation-and-configuration/deploy-cortex-on-kubernetes/) for installation instructions and configuration.

# -- Override the name of the chart
nameOverride: ""
# -- Override the full name of the chart
fullnameOverride: ""

# -- Image pull secrets for private registries
imagePullSecrets: []
#  - name: "image-pull-secret"

cortex:
  # -- Additional labels to attach to Cortex resources
  labels: {}
  # -- Additional annotations to attach to Cortex resources
  annotations: {}

  # -- Additional labels to attach to Cortex pods
  podLabels: {}
  # -- Additional annotations to attach to Cortex pods
  podAnnotations: {}

  # -- Number of Cortex replicas
  replicas: 1

  strategy:
    # -- Deployment strategy type
    type: RollingUpdate
    rollingUpdate:
      # -- Maximum number of pods that can be created over the desired number of pods
      maxSurge: 1
      # -- Maximum number of pods that can be unavailable during the update
      maxUnavailable: 0

  # -- Resource requests and limits for Cortex pods
  resources:
    requests:
      cpu: "1000m"
      memory: "2048Mi"
      ephemeral-storage: "4Gi"
    limits:
      cpu: "3000m"
      memory: "3584Mi"
      ephemeral-storage: "4Gi"

  # -- JVM options for Cortex application
  jvmOpts: "-Xms2g -Xmx2g -Xmn300m"

  image:
    # -- Docker registry for Cortex image
    registry: docker.io
    # -- Cortex image repository
    repository: thehiveproject/cortex
    # -- Cortex image tag (defaults to chart appVersion if not set)
    tag: ""
    # -- Image pull policy
    pullPolicy: IfNotPresent

  index:
    # -- ElasticSearch username for index connection
    username: "elastic"
    # -- ElasticSearch password for index connection (should match ElasticSearch subchart credentials if enabled)
    password: ""
    # -- Name of existing Kubernetes secret containing ElasticSearch password
    k8sSecretName: ""
    # -- Key in the secret containing ElasticSearch password
    k8sSecretKey: "elasticsearch-password"
    # -- List of ElasticSearch hostnames (auto-configured if ElasticSearch subchart is enabled and this is empty)
    hostnames: []
      #- "myelasticsearch.example.com"

  # -- Directory in Cortex container used to communicate with running jobs (write inputs and read outputs)
  jobDirectory: "/tmp/cortex-jobs"

  # -- HTTP secret for Cortex application (must be at least 32 characters)
  httpSecret: "ChangeThisSecretWithOneContainingAtLeast32Chars"
  # -- Name of existing Kubernetes secret containing Cortex HTTP secret
  k8sSecretName: ""
  # -- Key in the secret containing Cortex HTTP secret
  k8sSecretKey: "http-secret"

  persistentVolumeClaim:
    # -- Create a PVC or use an existing one (ReadWriteMany accessMode is MANDATORY for Cortex to share data with job pods)
    create: true
    # -- Name of the PVC to create/use (auto-generated if empty and create is true)
    name: ""
    # -- Storage class for persistent volume (use "-" to disable dynamic provisioning, "" for default provisioner)
    storageClass: ""
    # -- Size of the persistent volume
    size: 10Gi

  # -- Extra command-line arguments for Cortex entrypoint
  extraCommand: []

  # -- Extra environment variables for Cortex container
  extraEnv: []
    #- name: "EXAMPLE"
    #  value: "example"
    #- name: "FROM_CM"
    #  valueFrom:
    #    configMapKeyRef:
    #      name: "cm-name"
    #      key: "key-name"
    #- name: "FROM_SECRET"
    #  valueFrom:
    #    secretKeyRef:
    #      name: "cm-name"
    #      key: "key-name"

  # -- Custom application.conf configuration file content for Cortex
  configFile: |
    # Cortex configuration file
    # See https://docs.strangebee.com/cortex/installation-and-configuration/#configuration-guides
    analyzer {
      urls: [
        "https://catalogs.download.strangebee.com/latest/json/analyzers.json",
      ]

      # Customize analyzers parallelism here
      fork-join-executor {
        parallelism-min: 8,
        parallelism-factor: 1.0,
        parallelism-max: 8,
      }
    }

      # Customize responders parallelism here
    responder {
      urls: [
        "https://catalogs.download.strangebee.com/latest/json/responders.json",
      ]

      fork-join-executor {
        parallelism-min: 8,
        parallelism-factor: 1.0,
        parallelism-max: 8,
      }
    }

    # ElasticSearch
    search {
      # Set default value for the password
      password = ""
      # Override credentials (if these environment variables exist)
      user = ${?CORTEX_ELASTICSEARCH_USERNAME}
      password = ${?CORTEX_ELASTICSEARCH_PASSWORD}
    }

  # -- Custom logback.xml logging configuration file content for Cortex
  logbackXml: ""
  #logbackXml: |
  #  <!-- Cortex logs configuration file -->
  #  <!-- See https://docs.strangebee.com/cortex/installation-and-configuration/#configuration-guides -->

  startupProbe:
    # -- Enable startup probe (set failureThreshold high to prevent CrashLoops during schema migrations)
    enabled: true
    # -- Initial delay before startup probe begins
    initialDelaySeconds: 0
    # -- Frequency of startup probe checks
    periodSeconds: 5
    # -- Timeout for each startup probe attempt
    timeoutSeconds: 1
    # -- Number of failures before marking pod as failed
    failureThreshold: 36

  livenessProbe:
    # -- Enable liveness probe
    enabled: true
    # -- Initial delay before liveness probe begins
    initialDelaySeconds: 0
    # -- Frequency of liveness probe checks
    periodSeconds: 10
    # -- Timeout for each liveness probe attempt
    timeoutSeconds: 1
    # -- Number of failures before restarting container
    failureThreshold: 3

  readinessProbe:
    # -- Enable readiness probe
    enabled: true
    # -- Initial delay before readiness probe begins
    initialDelaySeconds: 0
    # -- Frequency of readiness probe checks
    periodSeconds: 10
    # -- Timeout for each readiness probe attempt
    timeoutSeconds: 1
    # -- Number of successes before marking pod as ready
    successThreshold: 1
    # -- Number of failures before marking pod as not ready
    failureThreshold: 3

  serviceAccount:
    # -- Create a service account for Cortex
    create: true
    # -- Name of the service account (generated if empty)
    name: ""
    # -- Annotations for the service account
    annotations: {}
    # -- Automatically mount Kubernetes API credentials
    automountServiceAccountToken: true

  initContainers:
    image:
      # -- Docker registry for init container image
      registry: docker.io
      # -- Init container image repository
      repository: curlimages/curl
      # -- Init container image tag
      tag: "8.17.0"
      # -- Init container image pull policy
      pullPolicy: IfNotPresent

    checkElasticsearch:
      # -- Enable init container to wait for ElasticSearch readiness
      enabled: true
      # -- Use HTTPS for ElasticSearch readiness check
      useHttps: false

  # -- Pod-wide security context
  podSecurityContext: {}
    #fsGroup: 2000

  # -- Container-level security context
  securityContext: {}
    #allowPrivilegeEscalation: false

  service:
    # -- Kubernetes service type
    type: ClusterIP
    # -- Cortex application port
    port: 9001

  ingress:
    # -- Enable ingress resource creation
    enabled: false
    # -- Ingress class name
    className: ""
    # -- Ingress annotations
    annotations: {}
      #kubernetes.io/ingress.class: nginx
      #kubernetes.io/tls-acme: "true"
    # -- Ingress hosts configuration
    hosts:
      - host: cortex.example
        paths:
          - path: /
            pathType: ImplementationSpecific
    # -- Ingress TLS configuration
    tls: []
      #- secretName: cortex-tls
      #  hosts:
      #    - cortex.example

  # -- Additional volumes for Cortex deployment
  volumes: []
    #- name: foo
    #  secret:
    #    secretName: mysecret
    #    optional: false

  # -- Additional volume mounts for Cortex container
  volumeMounts: []
    #- name: foo
    #  mountPath: "/etc/foo"
    #  readOnly: true

  # -- Node selector for pod assignment
  nodeSelector: {}

  # -- Tolerations for pod assignment
  tolerations: []

  # -- Affinity rules for pod assignment
  affinity: {}

####################################
# ElasticSearch subchart variables #
####################################

elasticsearch:
  # -- Enable ElasticSearch dependency subchart deployment
  enabled: true

  global:
    security:
      # -- Allow insecure images to use bitnamilegacy repository
      allowInsecureImages: true

  image:
    # -- ElasticSearch image registry (Cortex only supports ElasticSearch v7)
    registry: docker.io
    # -- ElasticSearch image repository
    repository: bitnamilegacy/elasticsearch
    # -- ElasticSearch image tag
    tag: "7.17.26-debian-12-r0"

  security:
    # -- TLS configuration for ElasticSearch
    tls: {}
    # -- Enable security features (requires TLS configuration)
    enabled: false
    # -- ElasticSearch elastic user password
    elasticPassword: ""
    # -- Name of existing secret with ElasticSearch password (expects .data.elasticsearch-password key)
    existingSecret: ""

  master:
    # -- Deploy master-only nodes or multipurpose nodes (master, data, coordinating, ingest)
    masterOnly: false

    # -- Number of master-eligible ElasticSearch replicas
    replicaCount: 1
    pdb:
      # -- Create PodDisruptionBudget for ElasticSearch master nodes
      create: true
      # -- Maximum unavailable master nodes
      maxUnavailable: "1"

    # -- Resource requests and limits for ElasticSearch master nodes
    resources:
      requests:
        cpu: "1000m"
        memory: "2048Mi"
        ephemeral-storage: "4Gi"
      limits:
        cpu: "2000m"
        memory: "3584Mi"
        ephemeral-storage: "4Gi"

    # -- Heap size for ElasticSearch master nodes
    heapSize: "2g"
    # -- Extra environment variables for ElasticSearch master nodes
    extraEnvVars:
      - name: JVM_OPTS
        value: "-Xms2g -Xmx2g -Xmn200m"

    persistence:
      # -- Enable persistent volume for ElasticSearch master nodes
      enabled: true
      # -- Storage class for ElasticSearch master node persistent volume
      storageClass: ""
      # -- Size of ElasticSearch master node persistent volume
      size: "10Gi"

    networkPolicy:
      # -- Enable network policy for ElasticSearch master nodes
      enabled: false

  data:
    # -- Number of data-dedicated node replicas (disabled by default)
    replicaCount: 0

  coordinating:
    # -- Number of coordinating-dedicated node replicas (disabled by default)
    replicaCount: 0

  ingest:
    # -- Number of ingest-dedicated node replicas (disabled by default)
    replicaCount: 0

  metrics:
    image:
      # -- ElasticSearch metrics exporter image registry
      registry: docker.io
      # -- ElasticSearch metrics exporter image repository
      repository: bitnamilegacy/elasticsearch-exporter
      # -- ElasticSearch metrics exporter image tag
      tag: 1.9.0-debian-12-r14

  volumePermissions:
    image:
      # -- Volume permissions init container image registry
      registry: docker.io
      # -- Volume permissions init container image repository
      repository: bitnamilegacy/os-shell
      # -- Volume permissions init container image tag
      tag: 12-debian-12-r49

  sysctlImage:
    # -- Sysctl init container image registry
    registry: docker.io
    # -- Sysctl init container image repository
    repository: bitnamilegacy/os-shell
    # -- Sysctl init container image tag
    tag: 12-debian-12-r49
